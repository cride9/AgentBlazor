@inject IJSRuntime JSRuntime
@inject AgentService AgentService
@implements IAsyncDisposable
@using System.Text

<div class="flex justify-center w-full">
    <div class="relative w-full max-w-3xl">
        @if (ShowIntro)
        {
            <div class="absolute bottom-full mb-4 w-full flex justify-center items-center gap-2">
                <img class="w-12 h-12" src="evaLogoTransparent.png" alt="EVA Logo">
                <p class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                    What can I do for you?
                </p>
            </div>
        }

        <div @ref="dropZoneElement" class="@DropZoneCssClass">
            @if (isDragOver)
            {
                <div class="@(isDragOver ? "overflow-hidden" : "overflow-auto") absolute inset-0 bg-purple-100/50 dark:bg-purple-900/50 flex items-center justify-center rounded-2xl pointer-events-none z-10 border-2 border-dashed border-purple-500 dark:border-purple-400 backdrop-blur-sm">
                    <div class="text-center p-4 scale-75">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-purple-500/20 mb-3">
                            <svg class="w-8 h-8 text-purple-600 dark:text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                        </div>
                        <p class="font-bold text-lg text-purple-600 dark:text-purple-300 mb-1">Drop file to upload</p>
                    </div>
                </div>
            }

            <InputTextArea @ref="textAreaInputRef"
                           @onkeydown="HandleKeyDown"
                           @oninput="HandleInput"
                           @bind-Value="currentMessage"
                           class=@($"{(isDragOver ? "overflow-hidden" : "overflow-auto")} custom-scrollbar flex-grow outline-0 bg-transparent caret-purple-500 dark:caret-[#dcd0ff] w-full resize-none text-base placeholder-gray-500 dark:placeholder-gray-400 p-2")
                           rows="1"
                           placeholder="Message EVA...">
            </InputTextArea>

            <div class="pt-2">
                <div class="w-full flex justify-between items-center text-xs">
                    <div class="flex space-x-2">
                        <button title="Voice Search Off" class="border bg-gray-100 dark:bg-[#222222] border-gray-300 dark:border-[#3d3d3d] rounded-full w-10 h-10 flex justify-center items-center text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-purple-100/20 transition"><MicrophoneSlashIcon /></button>
                        <button title="Voice Search On" class="border bg-purple-600 dark:bg-[#514d5f] border-purple-700 dark:border-[#3d3d3d] rounded-full w-10 h-10 flex justify-center items-center text-white dark:text-gray-200"><MicrophoneIcon /></button>
                    </div>
                    <button disabled="@IsDisabled" @onclick="SendMessage" title="Send Message" class="bg-purple-600 dark:bg-[#dcd0ff] w-10 h-10 rounded-full flex items-center justify-center hover:bg-purple-700 dark:hover:bg-purple-300 transition"><ArrowUpIcon /></button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string? currentMessage;
    private InputTextArea? textAreaInputRef;
    private bool IsDisabled = false;

    private ElementReference dropZoneElement;
    private DotNetObjectReference<ChatInput>? objRef;
    private bool isDragOver;
    private string DropZoneCssClass => new StringBuilder("relative flex flex-col border bg-white dark:bg-[#2b2b2b] shadow-lg dark:drop-shadow-[0_15px_35px_rgba(220,208,255,0.15)] rounded-2xl p-2 max-h-[50vh] overflow-y-auto custom-scrollbar transition-colors duration-200 ")
        .Append(isDragOver ? "border-purple-500 dark:border-purple-400" : "border-gray-300 dark:border-[#353535]")
        .ToString();

    [Parameter]
    public bool ShowIntro { get; set; }

    [Parameter]
    public EventCallback<string> OnSendMessage { get; set; }

    [Parameter]
    public EventCallback OnFileUpload { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("fileDropInterop.initialize", dropZoneElement, objRef);
        }
    }

    [JSInvokable]
    public async Task HandleFileDrop(string fileName, byte[] fileContent)
    {
        await OnFileUpload.InvokeAsync(); // Tell parent to ensure session is active

        var result = await AgentService.SaveFileToAgentDirectoryAsync(fileName, fileContent);
        if (result.StartsWith("Error:"))
        {
            currentMessage = result;
        }
        else
        {
            currentMessage = $"File '{result}' uploaded. You can now ask me to use it.";
        }
        await JSRuntime.InvokeVoidAsync("textAreaInterop.autoResize", textAreaInputRef?.Element);
        await InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void SetDragOver(bool value)
    {
        if (isDragOver != value)
        {
            isDragOver = value;
            StateHasChanged();
        }
    }

    private async Task HandleInput(ChangeEventArgs e)
    {
        await JSRuntime.InvokeVoidAsync("textAreaInterop.autoResize", textAreaInputRef?.Element);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey && !IsDisabled)
        {
            await JSRuntime.InvokeVoidAsync("textAreaInterop.blurElement", textAreaInputRef?.Element);
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(currentMessage))
            return;

        IsDisabled = true;
        var message = currentMessage.Trim();

        // clear first, then trigger UI update
        currentMessage = string.Empty;
        textAreaInputRef.Value = string.Empty;

        await InvokeAsync(StateHasChanged);
        await Task.Yield();
        await JSRuntime.InvokeVoidAsync("textAreaInterop.autoResize", textAreaInputRef?.Element);
        await InvokeAsync(StateHasChanged);

        await OnSendMessage.InvokeAsync(message);
        IsDisabled = false;
    }

    public async ValueTask DisposeAsync()
    {
        if (objRef != null)
        {
            objRef.Dispose();
        }
    }
}